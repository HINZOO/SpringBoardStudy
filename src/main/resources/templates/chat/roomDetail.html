<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<div layout:fragment="content" >
    <h1 class="my-4">
        <span th:text="${crId}"></span>
        ì±„íŒ…ë°© ìƒì„¸
    </h1>
    <div class="card">
        <div class="card-header">
            <h2 class="text-center mb-0">ì±„íŒ… ë‚´ì—­</h2>
        </div>

        <div class="card-body overflow-scroll" id="msgCont" style="height:60vh">
            <!--ê¸°ë³¸í‹€ì„ ì¡ê³  ì»´í¬ë„ŒíŠ¸ë¡œ ìƒì„±-->
            <!--enterMsg-->
            <!--leaveMsg-->
        </div>
        <!--reciveMsg-->
        <!--sendMsg-->
        <div class="card-footer">
            <!--ì±„íŒ…ì„ ë³´ë‚´ëŠ” í¼-->
            <form  class="sendMsgForm">
                <input type="hidden" name="uId" th:value="${session.loginUser.uId}">
                <input type="hidden" name="crId" th:value="${crId}">
                <input type="hidden" name="status" value="CHAT">
                <input type="text" name="nickName" value="">
                <div class="input-group">
                    <textarea name="content" disabled class="form-control"></textarea>
                    <button name="submitBtn" disabled class="btn btn-primary"><i class="bi bi-send"></i></button>
                </div>
            </form>
        </div>
    </div>
    <!--ğŸ€ ì…ì¥ í¼-->
    <form class="my-4" name="enterMsgForm">
        <input type="hidden" name="uId" th:value="${session.loginUser.uId}">
        <input type="hidden" name="crId" th:value="${crId}">
        <input type="hidden" name="status" value="ENTER">
        <input type="hidden" name="content" th:value="ì…ì¥">
        <div class="input-group mx-auto" style="width: 400px;">
            <div class="form-floating">
                <input class="form-control" name="nickName" type="text" placeholder="ë‹‰ë„¤ì„">
                 <label>ë‹‰ë„¤ì„</label>
            </div>
            <button name="submitBtn" class="btn btn-success">ì…ì¥</button>
        </div>
    </form>
    <script th:inline="javascript">
        // 1.ì»´í¬ë„ŒíŠ¸ ìƒì„±
        // 2.ì±„íŒ…ë°© ë‚´ì—­ì€ í•´ë‹¹ ë°© ë²ˆí˜¸ë§Œ ì¶œë ¥ //CHAT ì¸ë° ë¡œê·¸ì¸ìœ ì €ì¸ê²ƒì€ SEND ì•„ë‹Œê±´ LEAVE
        let listUrl=`/chat/msg/[[${crId}]]/list.do`;//consoleì— listUrlì„ ì³ë³´ê³  ë²ˆí˜¸ ì˜ ë“¤ì–´ì˜¤ëŠ”ì§€ í™•ì¸
        const msgCont =document.getElementById("msgCont");
        const LOGIN_USER_ID=[[${session.loginUser.uId}]];//ë”°ì˜´í‘œ í•„ìˆ˜~
        //3.ì…ì¥í¼+ì±„íŒ…ë°œì†¡í¼
        const enterMsgForm=document.forms["enterMsgForm"];
        const sendMsgForm=document.forms["sendMsgForm"];
        let lastPostTime;//ë©”ì„¸ì§€ë¥¼ ë¡œë“œí•˜ë‹¤ê°€ ë§ˆì§€ë§‰ ë©”ì„¸ì§€ ë“±ë¡ ì‹œê°„
        //ë§Œì•½ if(lastPostTime)? listUrlì— postTimeì„ urlì— ë³´ë‚¸ë‹¤.

        //í™”ë©´ì´ ì „ì²´ ë¡œë“œ ë˜ëŠ” ì´ë²¤íŠ¸
        document.addEventListener("DOMContentLoaded",async (e)=>{
            await loadMsgs();
            // setInterval(async ()=>{
            //     await loadMsgs();
            // },3000);//ë¬´ì¡°ê±´polling

            //ì¬ê·€í•¨ìˆ˜ í´ë§ì‹œ
            //await autoLoadMsgs();
        })
        //ì¬ê·€í•¨ìˆ˜ë¡œ ë¡œë“œëœ ì‹œì ì— í´ë§í•˜ê¸°
        // async function autoLoadMsgs(){
        //     let result=await loadMsgs();
        //     if(result){//ë¡œë“œ ì„±ê³µì‹œ
        //         //ì¬ê·€í•¨ìˆ˜ì‹œ
        //         //await new Promise(resolve)=>setTimeout(()=>{},1000);
        //         await autoLoadMsgs();
        //     }
        // }


        //ì±„íŒ…ë©”ì„¸ì§€ ë“±ë¡
        // sendMsgForm.onsubmit=async (e)=>{
        //     e.preventDefault()
        //     let register=await registerMsg(sendMsgForm);
        //     if(register>0){
        //         sendMsgForm.content.value="";
        //         await loadMsgs();
        //     }
        // }

        //ì…ì¥ì‹œë„
        enterMsgForm.onsubmit=async(e)=>{
            e.preventDefault();
            let register=await registerMsg(enterMsgForm);
            if(register>0){
                await loadMsgs();//ì„±ê³µí•˜ë©´ í™”ë©´ì„ ìƒˆë¡œê³ ì¹¨.
                //ì…ì¥ì—ì„±ê³µí•˜ë©´ ë˜ ì…ì¥ëª»í•˜ë„ë¡ ì§€ì •
                enterMsgForm.nickName.setAttribute("disabled",'');
                enterMsgForm.submitBtn.setAttribute("disabled",'');
                sendMsgForm.nickName.value=enterMsgForm.nickName.value;
                sendMsgForm.content.removeAttribute("disabled");
                sendMsgForm.submitBtn.removeAttribute("disabled");
            }else{
                alert("ì…ì¥ì‹¤íŒ¨")
            }
        }
        async function registerMsg(formNode){//ì…ì¥ ë˜ëŠ” ì±„íŒ…ë‚´ìš©ì„ ì±„íŒ…ë‚´ì—­ì— ë“±ë¡í•˜ëŠ” ë©”ì†Œë“œ
            let url="/chat/msg/register.do"
            const data=new FormData(formNode);
            const resp=await fetch (url,{method:"POST",body:data})
            if(resp.status===200){
                let register= await resp.text(); //"0"ì´ë©´ ì‹¤íŒ¨ ,"1"ì´ë©´ ì„±ê³µ
                return register;
            }
        }

        //ì „ì²´ë¡œë“œ ë¦¬ìŠ¤íŠ¸.
        async function loadMsgs(){//í•´ë‹¹ ë°©ë²ˆí˜¸ì˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜´.
            let url=listUrl;
            if(lastPostTime) url+="?postTime="+lastPostTime; //ë§ˆì§€ë§‰ìˆ˜ì •ì‹œê°„ì´ ìˆëŠ”ê²½ìš° íŒŒë¼ë¯¸í„°ë¡œ ìˆ˜ì •ì‹œê°„ì„ ë³´ëƒ„.
            const response=await fetch(url);
            if(response.status===200) {
                const msgs = await response.json();
                msgs.forEach((msg,i) => {
                    if((msgs.length-1)===i){//í˜„ì¬ ì¶œë ¥ëœ ì‹œê°„ ì´í›„ì˜ ë‚´ì—­ë“¤ë§Œ ì¶œë ¥í•˜ê³  ì‹¶ì„ë•Œ
                        lastPostTime=msg.postTime;
                    }
                    if (msg.status === 'CHAT') {
                        if (LOGIN_USER_ID === msg.uId) {//ë¡œê·¸ì¸í•œ ìœ ì €ê°€ ë³´ë‚¸ ë©”ì„¸ì§€
                            msgCont.insertAdjacentHTML("beforeend", sendMsgComponent(msg));
                        } else {
                            msgCont.insertAdjacentHTML("beforeend", receiveMsgComponent(msg));
                        }
                    } else if (msg.status === 'ENTER') {
                        msgCont.insertAdjacentHTML("beforeend", enterMsgComponent(msg));
                    } else if (msg.status === 'LEAVE') {
                        msgCont.insertAdjacentHTML("beforeend", leaveMsgComponent(msg));
                    }
                });
            }
        }

        function enterMsgComponent(msgObj){
            return `
               <div class="text-center">
                    <strong>${msgObj.nickName}</strong>
                    <small>${msgObj.uId}</small>
                    ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.<br>
                    <small class="text-muted">${msgObj.postTime}</small>
               </div>
            `;
        }
        function leaveMsgComponent(msgObj){
            return `
               <div class="text-center">
                    <strong>${msgObj.nickName}</strong>
                    <small>${msgObj.uId}</small>
                    ë‹˜ì´ í‡´ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.<br>
                    <small class="text-muted">${msgObj.postTime}</small>
               </div>
            `;
        }

        function receiveMsgComponent(msgObj){
            return`
                <div class="d-flex m-2">
                    <div class="align-self-start d-flex flex-column">
                        <strong>${msgObj.nickName}</strong>
                        <small>${msgObj.uId}</small>
                    </div>
                    <div class="bg-success bg-opacity-25 rounded-2 p-3 mx-2">
                        ${msgObj.content}
                    </div>
                    <div class="align-self-end">
                       <small class="text-muted">${msgObj.postTime}</small>
                    </div>
                </div>
            `;
        }

        function sendMsgComponent(msgObj){
            return `
                <div class="d-flex m-2 justify-content-end">
                    <div class="align-self-end">
                    <small class="text-muted">${msgObj.postTime}</small>
                    </div>
                    <div class="bg-warning bg-opacity-25 rounded-2 p-3 mx-2">
                          ${msgObj.content}
                     </div>
                     <div class="align-self-start d-flex flex-column">
                        <strong>${msgObj.nickName}</strong>
                        <small>${msgObj.uId}</small>
                     </div>
                </div>
            `
        }
    </script>

</div>